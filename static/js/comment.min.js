$(function(){var e=false;var f={updating:"正在提交评论...",success:"评论成功，正在更新评论列表...",miss:"评论失败，请填写所有必填信息，谢谢你。",fail:"评论失败，请确保全部信息填写正确，谢谢你。",nochn:"评论失败，评论中必须包含中文！",notrobot:'评论失败，请点击"我不是机器人"按钮！',toofast:"评论别太快哦。。请先喝杯咖啡再说:)",internalError:"服务器出现错误，请尝试重新提交，谢谢你。",praiseOnlyOnce:"您已经给过赞了哦，谢谢支持！"};var g={sp_comment_a:" <a href='网址'>网址</a> ",sp_comment_p:" <p>换行的文字</p> ",sp_comment_b:" <b>加粗的字</b> ",sp_comment_strong:" <strong>加粗的字</strong> ",sp_comment_pre:" <pre>您的代码</pre> "};if(!String.prototype.supplant){String.prototype.supplant=function(q){return this.replace(/{([^{}]*)}/g,function(t,s){var u=q[s];return typeof u==="string"||typeof u==="number"?u:t})}}String.prototype.replaceAll=function(r,q){return this.replace(new RegExp(r,"gm"),q)};$("#commentForm").ajaxForm({beforeSubmit:i,success:n});$("div.reply").on("click",function(){var q=$.trim($(this).siblings("header").children("cite").text());var s=$.trim($(this).parents("li:first").attr("id"));var r=s.split("-")[1];$("form#commentform input[type=button]:last").val("取消对"+q+"回应").show();$("html, body").scrollTop($("#commentform").offset().top);$("#id_reply_to_comment").val(r)});$("form#commentform input[type=button]:last").click(function(){var r=$("#id_reply_to_comment");var q=r.val();r.val("");$(this).hide()});var b="/service/comments/"+$("#article_id").val()+"/",c=$("#messageLength"),h=$("#commentList"),m=' <li>                         <div class="commenterImage">                                <span class="glyphicon glyphicon-user" aria-hidden="true"></span>                               <span class="commenterUserName">{userName}</span>                           </div>                          <div class="commentText">                               <p>{messageContent}</p><span class="date sub-text">on {created}</span>                         </div>                      </li>';function k(q){return $.extend(q,{created:dateFormat(q.created,"yyyy-mm-dd, h:MM:ss TT")})}function l(){$.getJSON(b).done(function(q){h.empty();$.each(q,function(){var r=k(this);h.append(m.supplant(r))});c.text(q.length==0?"没有评论":q.length+"条评论:");j()})}function j(){$("pre").addClass("prettyprint linenums").attr("style","overflow:auto");prettyPrint()}function a(){var q="/service/evaluation/"+$("#article_id").val()+"/";var r=$("#commentForm").serialize();r=r+"&type=view";$.post(q,r,function(s){$("#spanThumbsUp").text(s.praiseCount);$("#spanEyeOpen").text(s.viewCount)})}function p(){var q="/service/announcement/";$.getJSON(q).done(function(r){if(r!=null&&r.announcement!=""){$(".announcement").html(r.announcement+'<span id="sp_close_announcement">X</span>');o();$("#sp_close_announcement").click(function(){$.cookie("announcement-close","true",{expires:2,path:"/"});$(".announcement").slideUp()})}})}function o(){if($.cookie("announcement-close")!=null){$(".announcement").slideUp()}else{$(".announcement").slideDown()}}function d(q){$.blockUI({message:q,css:{width:"350px",border:"none",padding:"15px 5px",backgroundColor:"#000","-webkit-border-radius":"3px","-moz-border-radius":"3px","border-radius":"3px",opacity:0.6,color:"#fff","font-weight":"bold"}})}function i(q,r,t){if(e){return false}for(itm in q){var v=q[itm];var s=v.name;var u=v.value;if(s=="userName"||s=="messageContent"){if(u==""||typeof u==undefined){d(f.miss);setTimeout($.unblockUI,1500);return false}}}if(!e){e=true}}function n(r,t){d(f.updating);var q="/service/comments/"+$("#article_id").val()+"/";var s=$("#commentForm").serialize();$.post(q,s,function(u){if(u==="201"){d(f.success);l();$("#messageContent").val("");$("#commentReview").html("");$.unblockUI()}else{if(u==="406"){d(f.toofast);setTimeout($.unblockUI,1500)}else{d(f.internalError);setTimeout($.unblockUI,1500)}}});if(e){e=false}}$(".glyphicon-thumbs-up").click(function(s){var q="/service/evaluation/"+$("#article_id").val()+"/";var r=$("#commentForm").serialize();r=r+"&type=praise";$.post(q,r,function(u){if(u==="400"){d(f.internalError);setTimeout($.unblockUI,1500);return}else{if(u==="406"){d(f.praiseOnlyOnce);setTimeout($.unblockUI,1500);return}else{$("#spanThumbsUp").text(u.praiseCount);var w=$("<b>").text("+"+1);var t=s.pageX,v=s.pageY;w.css({top:v-20,left:t,position:"absolute",color:"#E94F06"});$("body").append(w);w.animate({top:v-180,opacity:0,"font-size":"1.4em"},1500,function(){w.remove()});s.stopPropagation()}}})});$("#messageContent").keyup(function(r){var q=$("#messageContent").val().replace(/<script/g,"&lt;script").replace(/script>/g,"script&gt;");$("#commentReview").html(q)});$("#messageContent").bind("focus",function(){var q=setInterval(function(){$("#commentReview").html($("#messageContent").val())},1000);$(this).bind("blur",function(){clearInterval(q)})});$(".commentTips span").css("cursor","pointer").css("color","gray").css("font-weight","bold");$(".commentTips span").click(function(){var q=$("#messageContent").val();q=q+g[this.id];$("#messageContent").val(q)});if($("#messageLength").length>0){l();a()}p();j()});